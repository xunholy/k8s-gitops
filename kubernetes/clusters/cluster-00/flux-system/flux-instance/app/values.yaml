# Source: https://artifacthub.io/packages/helm/flux-instance/flux-instance
---
instance:
  distribution:
    artifact: oci://ghcr.io/controlplaneio-fluxcd/flux-operator-manifests:v0.33.0
    version: 2.x
  components:
    - source-controller
    - kustomize-controller
    - helm-controller
    - notification-controller
    - source-watcher
  commonAnnotations:
    fluxcd.controlplane.io/reconcile: "enabled"
    fluxcd.controlplane.io/reconcileEvery: "1h"
    fluxcd.controlplane.io/reconcileTimeout: "3m"
  cluster:
    multitenant: false
    networkPolicy: false
    domain: "cluster.local"
  commonMetadata:
    labels:
      app.kubernetes.io/name: flux
  sync:
    kind: OCIRepository
    url: oci://ghcr.io/mak011p/manifests/k8s-gitops-hayden
    ref: main
    path: ./clusters/cluster-00
  kustomize:
    patches:
      # Allow cluster-autoscaler to evict flux controllers if needed
      - patch: |-
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: all
          spec:
            template:
              metadata:
                annotations:
                  cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
              spec:
                containers:
                  - name: manager
                    imagePullPolicy: Always
                    resources:
                      limits:
                        memory: 2Gi
        target:
          kind: Deployment
      # Increase concurrency and requeue time for helm-controller
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --concurrent=10
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --requeue-dependency=5s
        target:
          kind: Deployment
          name: helm-controller
      # Increase concurrency and requeue time for kustomize-controller
      - patch: |-
          - op: replace
            path: /spec/template/spec/volumes/0
            value:
              name: temp
              emptyDir:
                medium: Memory
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --no-remote-bases=true
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --concurrent=10
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --requeue-dependency=5s
        target:
          kind: Deployment
          name: kustomize-controller
      # Enable Helm repositories caching
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --helm-cache-max-size=10
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --helm-cache-ttl=60m
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --helm-cache-purge-interval=5m
        target:
          kind: Deployment
          name: source-controller
      # Flux near OOM detection for Helm
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --feature-gates=OOMWatch=true
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --oom-watch-memory-threshold=95
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --oom-watch-interval=500ms
        target:
          kind: Deployment
          name: helm-controller
      # Increase concurrency and requeue time for source-controller
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --concurrent=10
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --requeue-dependency=5s
        target:
          kind: Deployment
          name: source-controller
      # KustomizeController SOPS decryption for all Kustomizations
      - patch: |-
          apiVersion: kustomize.toolkit.fluxcd.io/v1
          kind: Kustomization
          metadata:
            name: flux-system
            namespace: flux-system
          spec:
            decryption:
              provider: sops
              secretRef:
                name: sops-gpg
            postBuild:
              substitute: {}
              substituteFrom:
                - kind: ConfigMap
                  name: cluster-config
                - kind: Secret
                  name: cluster-secrets
        target:
          kind: Kustomization
          name: flux-system
      # Remove CPU limits from all controllers to avoid OOMKills
      - patch: |-
          - op: remove
            path: /spec/template/spec/containers/0/resources/limits/cpu
        target:
          kind: Deployment
      - # Disable chart digest tracking
        patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --feature-gates=DisableChartDigestTracking=true
        target:
          kind: Deployment
          name: helm-controller
      # Controller-level SOPS decryption
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --sops-age-secret=sops-age-secret
        target:
          kind: Deployment
          name: kustomize-controller
      # Watch configmaps and secrets attached to HelmReleases and Kustomizations
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --watch-configs-label-selector=owner!=helm
        target:
          kind: Deployment
          name: (helm-controller|kustomize-controller)
      # Cancel health checks on new Kustomizations revisions
      - patch: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --feature-gates=CancelHealthCheckOnNewRevision=true
        target:
          kind: Deployment
          name: kustomize-controller
