apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: app
  namespace: apps-preview
spec:
  serviceAccountName: flux
  inputsFrom:
    - apiVersion: fluxcd.controlplane.io/v1
      kind: ResourceSetInputProvider
      name: app-preview-pull-requests
  resources:
    - apiVersion: source.toolkit.fluxcd.io/v1
      kind: GitRepository
      metadata:
        name: app-<< inputs.id >>
        namespace: apps-preview
      spec:
        provider: github
        interval: 1m
        url: https://github.com/xunholy/k8s-gitops
        ref:
          commit: << inputs.sha >>
        secretRef:
          name: github-auth
    - apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      metadata:
        name: app-<< inputs.id >>
        namespace: apps-preview
        annotations:
          event.toolkit.fluxcd.io/preview-url: 'https://app-<< inputs.id >>.${CLUSTER_DOMAIN}'
          event.toolkit.fluxcd.io/pr-number: << inputs.id | quote >>
          event.toolkit.fluxcd.io/branch: << inputs.branch | quote >>
          event.toolkit.fluxcd.io/author: << inputs.author | quote >>
      spec:
        serviceAccountName: flux
        interval: 1m
        releaseName: app-<< inputs.id >>
        chart:
          spec:
            chart: << inputs.chart >>
            reconcileStrategy: Revision
            sourceRef:
              kind: GitRepository
              name: app-<< inputs.id >>
              namespace: apps-preview
        values:
          image:
            tag: << inputs.sha >>
          ingress:
            hosts:
              - host: 'app-<< inputs.id >>.${CLUSTER_DOMAIN}'
