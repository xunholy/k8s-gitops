---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Render Talos Integration Manifests"

on:
  push:
    branches:
      - main
    paths:
      - kubernetes/apps/base/kube-system/kubelet-csr-approver/app/values.yaml
      - kubernetes/apps/base/kube-system/kubelet-csr-approver/app/ocirepository.yaml
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Helm
        uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 # v4

      - name: Extract chart version from OCIRepository
        id: chart
        run: |
          VERSION=$(grep -A2 'ref:' kubernetes/apps/base/kube-system/kubelet-csr-approver/app/ocirepository.yaml | grep 'tag:' | awk '{print $2}')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Chart version: $VERSION"

      - name: Pull chart
        env:
          CHART_VERSION: ${{ steps.chart.outputs.version }}
        run: |
          helm pull oci://ghcr.io/postfinance/charts/kubelet-csr-approver \
            --version "$CHART_VERSION" \
            --untar \
            --destination /tmp/chart

      - name: Render manifest
        run: |
          helm template kubelet-csr-approver /tmp/chart/kubelet-csr-approver \
            --namespace kube-system \
            --values kubernetes/apps/base/kube-system/kubelet-csr-approver/app/values.yaml \
            --no-hooks \
            > /tmp/rendered.yaml

      - name: Setup yq
        uses: mikefarah/yq@bbdd97482f2d439126582a59689eb1c855944955 # v4.44.6

      - name: Build final manifest with header and annotations
        env:
          CHART_VERSION: ${{ steps.chart.outputs.version }}
        run: |
          {
          cat <<EOF
          # This manifest was generated by automation. DO NOT EDIT.
          # Chart: kubelet-csr-approver v${CHART_VERSION}
          # Source: oci://ghcr.io/postfinance/charts/kubelet-csr-approver
          # Values: kubernetes/apps/base/kube-system/kubelet-csr-approver/app/values.yaml
          EOF
          yq 'select(. != null) | .metadata.annotations += {"meta.helm.sh/release-name": "kubelet-csr-approver", "meta.helm.sh/release-namespace": "kube-system"}' /tmp/rendered.yaml
          } > talos/integrations/cert-approver/cert-approver.yaml

      - name: Update kustomization version
        env:
          CHART_VERSION: ${{ steps.chart.outputs.version }}
        run: |
          sed -i "s/version: .*/version: $CHART_VERSION/" \
            talos/integrations/cert-approver/kustomization.yaml

      - name: Check for changes
        id: diff
        run: |
          git diff --quiet talos/integrations/cert-approver/ && echo "changed=false" >> "$GITHUB_OUTPUT" || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit and push
        if: steps.diff.outputs.changed == 'true'
        env:
          CHART_VERSION: ${{ steps.chart.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add talos/integrations/cert-approver/
          git commit -m "chore(talos): re-render kubelet-csr-approver manifest v${CHART_VERSION}"
          git push
